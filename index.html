<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAPA Earning Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- AdsGram SDK -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <!-- Monetag SDK -->
    <script src='//libtl.com/sdk.js' data-zone='9678845' data-sdk='show_9678845'></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-btn { transition: all 0.3s ease; }
        .nav-btn.active { color: #4ade80; transform: translateY(-4px); }
        .page { display: none; }
        .page.active { display: block; }
        .btn-grad-green { background-image: linear-gradient(to right, #1D976C 0%, #93F9B9 51%, #1D976C 100%); }
        .btn-grad-blue { background-image: linear-gradient(to right, #00c6ff 0%, #0072ff 51%, #00c6ff 100%); }
        .btn-grad-purple { background-image: linear-gradient(to right, #DA22FF 0%, #9733EE 51%, #DA22FF 100%); }
        .btn-grad { transition: 0.5s; background-size: 200% auto; color: white; }
        .btn-grad:hover { background-position: right center; }
        .btn-disabled { background-image: none; background-color: #4b5563; cursor: not-allowed; opacity: 0.6; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen">

    <main class="flex-grow p-4 overflow-y-auto">
        <!-- Earn Page -->
        <div id="earnPage" class="page active">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-teal-400">PAPA Earning</h1>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-gray-700/50 p-4 rounded-xl text-center"><p class="text-gray-400 text-sm">Current Balance</p><p id="balance" class="text-2xl font-bold text-green-400">0.00</p></div>
                <div class="bg-gray-700/50 p-4 rounded-xl text-center"><p class="text-gray-400 text-sm">Lifetime Points</p><p id="lifetimePoints" class="text-2xl font-bold text-teal-300">0.00</p></div>
            </div>
            
            <div class="text-center my-6 space-y-4">
                <button id="viewAdBtn" class="w-full btn-grad btn-grad-green font-semibold py-3 px-6 rounded-lg shadow-lg text-lg">üí∞ Watch Ad (AdsGram)</button>
                <button id="viewMonetagRewardedAdBtn" class="w-full btn-grad btn-grad-purple font-semibold py-3 px-6 rounded-lg shadow-lg text-lg">üéÅ Watch & Earn (Monetag)</button>
                <button id="viewMonetagAdBtn" class="w-full btn-grad btn-grad-blue font-semibold py-3 px-6 rounded-lg shadow-lg text-lg" disabled>üíé Show Ad (For Pop-ups)</button>
            </div>
            <div id="messageArea" class="text-center mt-4 text-yellow-400 h-6"></div>
        </div>

        <!-- Other Pages (Refer, Withdraw, Profile) remain the same -->
        <div id="referPage" class="page">...</div>
        <div id="withdrawPage" class="page">...</div>
        <div id="profilePage" class="page">...</div>
    </main>

    <nav class="bg-gray-800 shadow-lg p-2 flex justify-around">...</nav>

    <script>
    // --- Configuration ---
    const ADSGRAM_BLOCK_ID = "13579"; // Your actual AdsGram block ID
    const SERVER_URL = 'https://papa-earning-app.onrender.com';
    let adController;
    let globalCooldownInterval;

    // --- DOM Elements ---
    const balanceElement = document.getElementById('balance');
    const lifetimePointsElement = document.getElementById('lifetimePoints');
    const viewAdBtn = document.getElementById('viewAdBtn');
    const viewMonetagAdBtn = document.getElementById('viewMonetagAdBtn');
    const viewMonetagRewardedAdBtn = document.getElementById('viewMonetagRewardedAdBtn');
    const messageArea = document.getElementById('messageArea');

    // ==========================================================
    // --- ‡™Æ‡´Å‡™ñ‡´ç‡™Ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶á (Main Changes Are Here) ---
    // ==========================================================

    function initializeAdsGram() {
        if (window.Adsgram && ADSGRAM_BLOCK_ID && ADSGRAM_BLOCK_ID !== "YOUR_ADSGRAM_BLOCK_ID") {
            try {
                adController = window.Adsgram.init({ blockId: ADSGRAM_BLOCK_ID });
            } catch(e) {
                console.error("AdsGram init failed:", e);
                disableButton(viewAdBtn, "AdsGram Error");
            }
        } else {
            disableButton(viewAdBtn, !window.Adsgram ? "Ad Service Error" : "Setup Required");
        }
    }

    /**
     * Call this ONLY after an ad is successfully watched.
     * adType: 'adsgram' | 'monetag_rewarded'
     */
    async function triggerReward(adType) {
        try {
            messageArea.textContent = 'Verifying reward...';
            const response = await fetch(`${SERVER_URL}/api/reward`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: adType })
            });
            const data = await response.json();
            
            if (response.ok) {
                messageArea.textContent = `üéâ Reward claimed!`;
                updateUIWithData(data, true); // Update UI and start cooldown
            } else {
                messageArea.textContent = data.error || "Could not claim reward.";
                // If reward fails, re-enable buttons
                resetAllButtonVisuals();
            }
        } catch (error) {
            console.error('Failed to trigger reward:', error);
            messageArea.textContent = "Server error. Could not claim reward.";
            resetAllButtonVisuals();
        }
    }

    // --- Corrected Ad Handling Functions ---

    function handleViewAd() {
        if (!adController || viewAdBtn.disabled) return;
        
        messageArea.textContent = 'Loading ad...';
        disableAllAdButtons();

        adController.show()
            .then(result => {
                // This block runs ONLY IF the ad was shown and closed successfully
                console.log('AdsGram ad finished successfully.', result);
                triggerReward('adsgram');
            })
            .catch(error => {
                // This block runs IF the user skips the ad or if there's an error
                console.error('AdsGram ad failed or was skipped:', error);
                messageArea.textContent = "Ad was skipped. No points earned.";
                resetAllButtonVisuals(); // Re-enable buttons as no reward was given
            });
    }

    function handleMonetagRewardedAd() {
        if (viewMonetagRewardedAdBtn.disabled) return;
        
        messageArea.textContent = 'Loading rewarded ad...';
        disableAllAdButtons();

        // The Monetag SDK's function returns a Promise
        show_9678845()
            .then(() => {
                // This block runs ONLY on successful completion
                console.log('Monetag rewarded ad completed.');
                triggerReward('monetag_rewarded');
            })
            .catch(() => {
                // This block runs IF the ad is skipped or fails
                console.error('Monetag rewarded ad failed or was skipped.');
                messageArea.textContent = "Rewarded ad skipped. No points.";
                resetAllButtonVisuals();
            });
    }
    
    // --- UI and Cooldown Helper Functions ---
    
    function disableAllAdButtons() {
        [viewAdBtn, viewMonetagRewardedAdBtn].forEach(btn => {
            btn.disabled = true;
            btn.classList.add('btn-disabled');
            btn.classList.remove('btn-grad-green', 'btn-grad-purple');
        });
    }

    function resetAllButtonVisuals() {
        [viewAdBtn, viewMonetagRewardedAdBtn].forEach(btn => btn.disabled = false);
        viewAdBtn.classList.remove('btn-disabled');
        viewAdBtn.classList.add('btn-grad-green');
        viewMonetagRewardedAdBtn.classList.remove('btn-disabled');
        viewMonetagRewardedAdBtn.classList.add('btn-grad-purple');
    }

    function startGlobalCooldownTimer(initialRemaining) {
        clearInterval(globalCooldownInterval);
        let remaining = Math.ceil(initialRemaining);
        disableAllAdButtons();

        globalCooldownInterval = setInterval(() => {
            if (remaining > 0) {
                messageArea.textContent = `Next ad bonus in ${remaining}s`;
                remaining--;
            } else {
                clearInterval(globalCooldownInterval);
                messageArea.textContent = 'Ad bonus is available now!';
                resetAllButtonVisuals();
            }
        }, 1000);
    }
    
    function disableButton(btn, text) {
        btn.textContent = text;
        btn.disabled = true;
        btn.classList.add('btn-disabled');
        btn.classList.remove('btn-grad-green', 'btn-grad-purple', 'btn-grad-blue');
    }

    async function fetchData() {
        try {
            const response = await fetch(`${SERVER_URL}/api/data`);
            if (!response.ok) throw new Error(`Network response: ${response.statusText}`);
            const data = await response.json();
            updateUIWithData(data, false);
        } catch (error) {
            console.error('Failed to fetch initial data:', error);
            messageArea.textContent = "Could not connect to server.";
        }
    }
    
    function updateUIWithData(data, startCooldown) {
        if (data.new_balance !== undefined) {
             balanceElement.textContent = data.new_balance.toFixed(2);
        }
        if (data.balance !== undefined) {
             balanceElement.textContent = data.balance.toFixed(2);
        }
        if (data.lifetime_points !== undefined) {
            lifetimePointsElement.textContent = data.lifetime_points.toFixed(2);
        }
        
        if(startCooldown) {
             const cooldownSeconds = 30; // Must match backend
             startGlobalCooldownTimer(cooldownSeconds);
        } else {
            // Check cooldown only on initial load
            const now = new Date().getTime() / 1000;
            const timePassed = now - data.last_ad_time;
            const cooldownSeconds = 30;
            if (timePassed < cooldownSeconds) {
                startGlobalCooldownTimer(cooldownSeconds - timePassed);
            }
        }
    }

    // --- Event Listeners & Initial Setup ---
    viewAdBtn.addEventListener('click', handleViewAd);
    viewMonetagRewardedAdBtn.addEventListener('click', handleMonetagRewardedAd);

    window.addEventListener('load', () => {
        Telegram.WebApp.ready();
        fetchData();
        initializeAdsGram();
        // The third Monetag button is for pop-ups, not for earning points directly.
        // It's better to disable it to avoid user confusion.
        disableButton(viewMonetagAdBtn, 'üíé For Pop-ups Only');
    });

    </script>
</body>
</html>