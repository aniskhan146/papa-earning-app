<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Papa Earning App</title>
</head>
<body>
  <h1>Welcome to Papa Earning App</h1>

  <div id="balance">Loading balance...</div>
  <button id="watchAdBtn">Watch Ad (Get Reward)</button>
  <button id="dailyBonusBtn">Claim Daily Bonus</button>
  <br/><br/>
  <input type="number" id="withdrawAmount" placeholder="Amount to withdraw" />
  <button id="withdrawBtn">Withdraw</button>

  <div id="message" style="margin-top:20px; color: green;"></div>
  <div id="error" style="margin-top:20px; color: red;"></div>

  <script>
    const BACKEND_URL = "https://papa-earning-app.onrender.com";

    const balanceDiv = document.getElementById('balance');
    const messageDiv = document.getElementById('message');
    const errorDiv = document.getElementById('error');

    // ইউজারের ডাটা নিয়ে আসার ফাংশন
    async function fetchUserData() {
      try {
        const res = await fetch(BACKEND_URL + '/api/data', {
          method: 'GET',
          credentials: 'include' // সেশন ও কুকি পাঠাতে হয়
        });
        const data = await res.json();
        if(data.balance !== undefined){
          balanceDiv.textContent = `Your balance: ${data.balance.toFixed(2)} points`;
        } else if(data.user_data && data.user_data.balance !== undefined){
          // যদি তোমার backend return করে user_data এর মধ্যে থাকে
          balanceDiv.textContent = `Your balance: ${data.user_data.balance.toFixed(2)} points`;
        } else {
          balanceDiv.textContent = 'Balance data not available';
        }
      } catch (err) {
        balanceDiv.textContent = 'Failed to load balance';
        console.error('Error fetching user data:', err);
      }
    }

    // রিওয়ার্ড দেওয়ার ফাংশন (যখন অ্যাড দেখা হয়)
    async function giveReward() {
      try {
        const res = await fetch(BACKEND_URL + '/api/reward', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ type: 'adsgram' })  // adsgram / monetag_rewarded / monetag_interstitial ইত্যাদি দিতে পারো
        });
        const data = await res.json();
        if(data.success){
          messageDiv.textContent = 'Reward added!';
          errorDiv.textContent = '';
          fetchUserData();  // আপডেট ব্যালেন্স দেখানোর জন্য
        } else {
          errorDiv.textContent = data.error || 'Failed to add reward';
          messageDiv.textContent = '';
        }
      } catch(err) {
        errorDiv.textContent = 'Error giving reward';
        messageDiv.textContent = '';
        console.error(err);
      }
    }

    // ডেইলি বোনাস ক্লেইম করার ফাংশন
    async function claimDailyBonus() {
      try {
        const res = await fetch(BACKEND_URL + '/api/daily_bonus', {
          method: 'POST',
          credentials: 'include'
        });
        const data = await res.json();
        if(data.success){
          messageDiv.textContent = data.message || 'Daily bonus claimed!';
          errorDiv.textContent = '';
          fetchUserData();
        } else {
          errorDiv.textContent = data.error || 'Failed to claim daily bonus';
          messageDiv.textContent = '';
        }
      } catch(err) {
        errorDiv.textContent = 'Error claiming daily bonus';
        messageDiv.textContent = '';
        console.error(err);
      }
    }

    // উইথড্রয়াল রিকোয়েস্ট করার ফাংশন
    async function withdrawPoints() {
      const amountInput = document.getElementById('withdrawAmount');
      const amount = parseFloat(amountInput.value);
      if(isNaN(amount) || amount <= 0){
        errorDiv.textContent = 'Please enter a valid withdrawal amount';
        messageDiv.textContent = '';
        return;
      }
      try {
        const res = await fetch(BACKEND_URL + '/api/withdraw', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ amount: amount })
        });
        const data = await res.json();
        if(data.success){
          messageDiv.textContent = data.message || 'Withdrawal requested!';
          errorDiv.textContent = '';
          fetchUserData();
        } else {
          errorDiv.textContent = data.error || 'Failed to withdraw';
          messageDiv.textContent = '';
        }
      } catch(err) {
        errorDiv.textContent = 'Error processing withdrawal';
        messageDiv.textContent = '';
        console.error(err);
      }
    }

    // ইভেন্ট লিসেনার যোগ করা
    document.getElementById('watchAdBtn').addEventListener('click', giveReward);
    document.getElementById('dailyBonusBtn').addEventListener('click', claimDailyBonus);
    document.getElementById('withdrawBtn').addEventListener('click', withdrawPoints);

    // প্রথমে পেজ লোড হলে ইউজারের ডেটা নিয়ে আসো
    fetchUserData();
  </script>
</body>
</html>
